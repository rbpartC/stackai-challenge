apiVersion: apps/v1
kind: Deployment
metadata:
  name: temporal-worker
spec:
  replicas: {{ .Values.temporal.worker.replicas }}
  selector:
    matchLabels:
      app: temporal-worker
  template:
    metadata:
      labels:
        app: temporal-worker
    spec:
      containers:
        - name: temporal-worker
          image: {{ .Values.temporal.image }}
          args: ["autosetup", "&&", "temporal-server", "start", "--service", "worker"]
          env:
            - name: DB
              value: postgres12
            - name: DBNAME
              value: {{ .Values.postgres.db }}
            - name: POSTGRES_USER
              value: {{ .Values.postgres.user }}
            - name: POSTGRES_PWD
              value: {{ .Values.postgres.password }}
            - name: POSTGRES_SEEDS
              value: {{ .Values.postgres.host }}
            - name: POSTGRES_TLS_ENABLED
              value: "false"
            - name: ENABLE_ES
              value: "true"
            - name: DB_PORT
              value: {{ .Values.postgres.port | quote }}
            - name: ES_SEEDS
              value: {{ .Values.elasticsearch.host }}
            - name: ES_PORT
              value: {{ .Values.elasticsearch.port | quote }}
            - name: ES_USER
              value: {{ .Values.elasticsearch.elastic_user }}
            - name: ES_PWD
              value: {{ .Values.elasticsearch.password }}
            - name: ES_VERSION
              value: {{ .Values.elasticsearch.version }}
            - name: ES_SCHEME
              value: "http"             
            - name: TEMPORAL_ADDRESS
              value: "{{ .Values.temporal.frontend.host }}:{{ .Values.temporal.frontend.grpcPort }}"
            - name: SKIP_SCHEMA_SETUP
              value: "true"
            - name: SKIP_DB_SETUP
              value: "true"
          ports:
            - name: grpc
              containerPort: {{ .Values.temporal.worker.grpcPort }}
            - name: membership
              containerPort: {{ .Values.temporal.worker.membershipPort }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Values.temporal.worker.host }}
spec:
  type: ClusterIP
  selector:
    app: temporal-worker
  ports:
    - name: grpc
      port: {{ .Values.temporal.worker.grpcPort }}
      targetPort: grpc
    - name: membership
      port: {{ .Values.temporal.worker.membershipPort }}
      targetPort: membership